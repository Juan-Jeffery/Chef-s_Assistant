<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weekly Planner | Chef's Assistant</title>
    <style>
        :root {
            --mo-blue: #92a8d1;
            --mo-green: #a2b9bc;
            --mo-rose: #b18597;
            --mo-grey: #8e8d8a;
            --mo-sand: #e3e2df;
            --mo-white: rgba(255, 255, 255, 0.9);
            --text-color: #5d5c58;
            --bg-gradient: linear-gradient(135deg, #92a8d1 0%, #cfd9df 100%);
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            margin: 0;
            padding: 40px 20px 80px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#8e8d8a 0.5px, transparent 0.5px);
            background-size: 30px 30px; opacity: 0.1; z-index: -1;
        }

        h1 {
            font-weight: 300; letter-spacing: 4px; text-transform: uppercase;
            margin-bottom: 40px; color: var(--mo-grey); border-bottom: 1px solid var(--mo-grey);
            padding-bottom: 10px;
        }

        .container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px;
            max-width: 1100px; width: 100%;
        }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        .card {
            background: var(--mo-white); backdrop-filter: blur(10px); border-radius: 12px;
            padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.3); transition: transform 0.3s;
        }

        .card h2 {
            font-size: 1.2rem; margin-top: 0; color: var(--mo-grey);
            border-left: 4px solid var(--mo-blue); padding-left: 10px;
        }

        .meal-section { border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px; margin-top: 15px; }

        .meal-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.85rem; color: var(--mo-grey); font-weight: bold;
        }

        .add-btn {
            background: none; border: 1px solid var(--mo-green); color: var(--mo-green);
            width: 26px; height: 26px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .food-entry { position: relative; margin-top: 12px; font-size: 0.9rem; padding-right: 30px; }
        .food-entry b { color: var(--mo-rose); display: block; }
        .food-entry span { font-size: 0.8rem; color: var(--mo-grey); }
        
        .del-entry-btn {
            position: absolute; right: 0; top: 0;
            border: none; background: none; color: #ccc;
            cursor: pointer; font-size: 1.1rem; padding: 5px;
            transition: color 0.2s;
        }
        .del-entry-btn:hover { color: var(--mo-rose); }

        .summary-card { background: rgba(162, 185, 188, 0.15); border: 1px dashed var(--mo-green); }
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .ing-tag {
            background: white; padding: 5px 12px; border-radius: 4px;
            font-size: 0.85rem; border-left: 3px solid var(--mo-blue);
        }
        .ing-tag span { margin-left: 8px; font-weight: bold; color: var(--mo-rose); }

        .back-link {
            margin-top: 50px; text-decoration: none; color: var(--mo-grey);
            font-size: 0.85rem; letter-spacing: 2px; border-bottom: 1px solid var(--mo-grey);
        }

        #modalOverlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; z-index: 1000;
        }

        .modal { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
        .modal h3 { font-weight: 400; margin-top: 0; color: var(--mo-grey); text-align: center; }
        
        .modal-label { font-size: 0.8rem; color: var(--mo-grey); margin-bottom: 5px; display: block; }
        input.main-input {
            width: 100%; border: none; border-bottom: 1px solid var(--mo-sand);
            padding: 10px 0; margin-bottom: 20px; outline: none; font-size: 1rem;
        }

        .ing-row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
        .ing-name { flex: 2; border: none; border-bottom: 1px solid #eee; padding: 5px; outline: none; }
        .qty-controls { flex: 1; display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; border-radius: 4px; padding: 2px 5px; }
        .qty-btn { border: none; background: none; color: var(--mo-blue); font-size: 1.2rem; cursor: pointer; padding: 0 5px; }
        .qty-val { font-size: 0.9rem; min-width: 20px; text-align: center; }

        .btn-add-row { 
            width: 100%; padding: 8px; border: 1px dashed var(--mo-green); 
            background: none; color: var(--mo-green); border-radius: 6px; 
            cursor: pointer; margin-bottom: 20px; font-size: 0.85rem;
        }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-save { flex: 1; background: var(--mo-blue); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; }
        .btn-cancel { flex: 1; background: none; border: 1px solid var(--mo-sand); color: var(--mo-grey); padding: 12px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Weekly Planner</h1>

    <div class="container">
        <div class="card" data-day="週一"><h2>週一</h2><div class="content"></div></div>
        <div class="card" data-day="週二"><h2>週二</h2><div class="content"></div></div>
        <div class="card" data-day="週三"><h2>週三</h2><div class="content"></div></div>
        <div class="card" data-day="週四"><h2>週四</h2><div class="content"></div></div>
        <div class="card" data-day="週五"><h2>週五</h2><div class="content"></div></div>
        
        <div class="card summary-card">
            <h2>食材清單統整</h2>
            <div class="tag-cloud" id="summaryBox">等待您的計畫...</div>
        </div>
    </div>

    <a href="../index.html" class="back-link">← 返回首頁</a>

    <div id="modalOverlay">
        <div class="modal">
            <h3>新增餐點</h3>
            <span class="modal-label">餐點名稱</span>
            <input type="text" id="foodName" class="main-input" placeholder="例如：番茄炒蛋">
            <span class="modal-label">食材清單</span>
            <div id="ingRowsContainer"></div>
            <button class="btn-add-row" onclick="addIngRow()">＋ 新增食材</button>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">取消</button>
                <button class="btn-save" onclick="saveData()">確認加入</button>
            </div>
        </div>
    </div>

    <script>
        const mealsTypes = ['早餐', '午餐', '晚餐'];
        const days = ['週一', '週二', '週三', '週四', '週五'];
        
        // --- 預設餐點資料庫 ---
        const defaultPool = {
            '早餐': [
                { food: '三明治', ings: [{ name: '吐司', qty: 2 }, { name: '火腿', qty: 1 }] },
                { food: '燕麥粥', ings: [{ name: '燕麥', qty: 1 }, { name: '牛奶', qty: 1 }] },
                { food: '蛋餅', ings: [{ name: '蛋餅皮', qty: 1 }, { name: '雞蛋', qty: 1 }] }
            ],
            '午餐': [
                { food: '雞肉沙拉', ings: [{ name: '雞胸肉', qty: 1 }, { name: '生菜', qty: 1 }] },
                { food: '牛肉麵', ings: [{ name: '牛肉', qty: 1 }, { name: '麵條', qty: 1 }] },
                { food: '番茄炒蛋飯', ings: [{ name: '番茄', qty: 1 }, { name: '雞蛋', qty: 2 }] }
            ],
            '晚餐': [
                { food: '煎牛排', ings: [{ name: '牛排', qty: 1 }, { name: '節瓜', qty: 1 }] },
                { food: '烤鮭魚', ings: [{ name: '鮭魚', qty: 1 }, { name: '蘆筍', qty: 1 }] },
                { food: '麻婆豆腐', ings: [{ name: '豆腐', qty: 1 }, { name: '豬肉末', qty: 1 }] }
            ]
        };

        let plannerData = {};
        let activeSelection = {};

        // 初始化頁面
        document.querySelectorAll('.card[data-day]').forEach(card => {
            const day = card.dataset.day;
            const container = card.querySelector('.content');
            mealsTypes.forEach(m => {
                const key = `${day}-${m}`;
                plannerData[key] = [];
                const div = document.createElement('div');
                div.className = 'meal-section';
                div.innerHTML = `
                    <div class="meal-header"><span>${m}</span><button class="add-btn" onclick="openModal('${day}', '${m}')">+</button></div>
                    <div id="list-${day}-${m}"></div>
                `;
                container.appendChild(div);
            });
        });

        // --- 隨機生成預設餐點功能 ---
        function generateRandomPlan() {
            days.forEach(day => {
                mealsTypes.forEach(type => {
                    const key = `${day}-${type}`;
                    // 從 Pool 中隨機選一個
                    const pool = defaultPool[type];
                    const randomPick = pool[Math.floor(Math.random() * pool.length)];
                    
                    // 加入資料結構 (深拷貝 ings 以防引用問題)
                    plannerData[key].push({
                        id: Date.now() + Math.random(),
                        food: randomPick.food,
                        ings: JSON.parse(JSON.stringify(randomPick.ings))
                    });
                    
                    renderMealList(key);
                });
            });
            updateGroceryList();
        }

        // 頁面加載後執行隨機生成
        window.onload = generateRandomPlan;

        function addIngRow(name = '', qty = 1) {
            const container = document.getElementById('ingRowsContainer');
            const row = document.createElement('div');
            row.className = 'ing-row';
            row.innerHTML = `
                <input type="text" class="ing-name" placeholder="食材名稱" value="${name}">
                <div class="qty-controls">
                    <button class="qty-btn" onclick="updateRowQty(this, -1)">-</button>
                    <span class="qty-val">${qty}</span>
                    <button class="qty-btn" onclick="updateRowQty(this, 1)">+</button>
                </div>
                <button style="border:none; background:none; color:#ddd; cursor:pointer;" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }

        function updateRowQty(btn, delta) {
            const valSpan = btn.parentElement.querySelector('.qty-val');
            let current = parseInt(valSpan.innerText);
            current = Math.max(1, current + delta);
            valSpan.innerText = current;
        }

        function openModal(d, m) {
            activeSelection = {d, m};
            document.getElementById('ingRowsContainer').innerHTML = '';
            addIngRow();
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('foodName').value = '';
        }

        function saveData() {
            const foodName = document.getElementById('foodName').value.trim();
            const rows = document.querySelectorAll('.ing-row');
            let tempIngs = [];
            rows.forEach(row => {
                const name = row.querySelector('.ing-name').value.trim();
                const qty = parseInt(row.querySelector('.qty-val').innerText);
                if(name) tempIngs.push({ name, qty });
            });
            if(!foodName || tempIngs.length === 0) return;
            const key = `${activeSelection.d}-${activeSelection.m}`;
            plannerData[key].push({ id: Date.now(), food: foodName, ings: tempIngs });
            renderMealList(key);
            updateGroceryList();
            closeModal();
        }

        function renderMealList(key) {
            const targetList = document.getElementById(`list-${key}`);
            targetList.innerHTML = '';
            plannerData[key].forEach(item => {
                const entry = document.createElement('div');
                entry.className = 'food-entry';
                const ingText = item.ings.map(i => `${i.name}x${i.qty}`).join(' / ');
                entry.innerHTML = `
                    <b>${item.food}</b>
                    <span>${ingText}</span>
                    <button class="del-entry-btn" onclick="deleteEntry('${key}', ${item.id})">✕</button>
                `;
                targetList.appendChild(entry);
            });
        }

        function deleteEntry(key, id) {
            plannerData[key] = plannerData[key].filter(item => item.id !== id);
            renderMealList(key);
            updateGroceryList();
        }

        function updateGroceryList() {
            const box = document.getElementById('summaryBox');
            const totalCounts = {};
            Object.values(plannerData).forEach(mealArray => {
                mealArray.forEach(meal => {
                    meal.ings.forEach(ing => {
                        totalCounts[ing.name] = (totalCounts[ing.name] || 0) + ing.qty;
                    });
                });
            });
            const keys = Object.keys(totalCounts);
            if(keys.length === 0) {
                box.innerHTML = "等待您的計畫...";
            } else {
                box.innerHTML = keys.map(k => `<div class="ing-tag">${k} <span>x ${totalCounts[k]}</span></div>`).join('');
            }
        }
    </script>
</body>
</html>