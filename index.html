<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>料理小幫手</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: "Noto Sans TC", "Helvetica Neue", sans-serif;
      padding: 40px 20px;
      background: #f9f9f7;
      color: #444;
      max-width: 900px;
      margin: auto;
    }

    h1, h2 {
      color: #333;
    }

    .section {
      margin-top: 3em;
    }

    /* 鍋具按鈕 */
    .tool-btn {
      margin: 5px;
      padding: 8px 16px;
      border: 1px solid #bbb;
      background-color: #ffffff;
      color: #555;
      cursor: pointer;
      border-radius: 6px;
      font-size: 15px;
      transition: all 0.25s ease;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.05);
    }

    .tool-btn.active {
      background-color: #a4b0be;
      color: white;
      font-weight: bold;
      border-color: #7f8fa6;
    }

    /* 可做料理按鈕 */
    #filteredRecipes button {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 5px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }

    #filteredRecipes button:hover {
      background: #dff2f2;
      border-color: #7fbbb3;
      color: #2d4e4e;
    }

    /* 已選料理清單 */
    #selectedRecipes label {
      display: inline-block;
      margin: 4px 10px 4px 0;
      padding: 6px 10px;
      background: #eee;
      border-radius: 6px;
      font-size: 14px;
    }

    #selectedRecipes input[type="checkbox"] {
      margin-right: 6px;
    }

    /* 排程區 */
    #scheduleResult, #ingredientResult {
      margin-top: 1em;
    }

    .timeline-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .timeline-label {
      width: 80px;
      font-weight: bold;
      color: #555;
    }

    .step-container {
      flex-grow: 1;
      position: relative;
      height: 40px;
      background: #eaeaea;
      max-width: calc(100vw - 130px);
      border-radius: 6px;
      overflow: hidden;
    }

    .step-block {
      position: absolute;
      top: 4px;
      height: 32px;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 13px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4em;
      display: flex;
      align-items: center;
      background: #7fbbb3;
      box-shadow: 1px 2px 4px rgba(0,0,0,0.1);
    }

    /* 按鈕 */
    #btnSchedule {
      padding: 10px 20px;
      background: #7fbbb3;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s ease;
      margin-bottom: 0.5em;
    }

    #btnSchedule:hover {
      background: #5e9d94;
    }

    /* 切換按鈕 */
    .view-tab {
      margin-right: 8px;
      padding: 6px 14px;
      border: 1px solid #aaa;
      background-color: #fff;
      cursor: pointer;
      border-radius: 5px;
      font-weight: 600;
      user-select: none;
      transition: background-color 0.3s, color 0.3s;
    }

    .active-tab {
      background-color: #007bff;
      color: white;
      border-color: #0056b3;
    }

    /* 食材清單樣式 */
    #ingredientResult div {
      padding: 4px 0;
      font-size: 15px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>料理小幫手</h1>

  <!-- 選擇鍋具 -->
  <div class="section">
    <h2>1. 選擇擁有的鍋具（點擊按鈕切換顯示）</h2>
    <div id="toolList">
      <button class="tool-btn" data-tool="無鍋具">無鍋具</button>
      <button class="tool-btn" data-tool="電鍋">電鍋</button>
      <button class="tool-btn" data-tool="湯鍋">湯鍋</button>
      <button class="tool-btn" data-tool="炒鍋">炒鍋</button>
    </div>
  </div>

  <!-- 可選料理 -->
  <div class="section">
    <h2>2. 可做料理（點擊按鈕加入下方清單）</h2>
    <div id="filteredRecipes"></div>
  </div>

  <!-- 已選料理 -->
  <div class="section">
    <h2>3. 所選料理（勾選欲排程項目）</h2>
    <div id="selectedRecipes"></div>
  </div>

  <!-- 排程 -->
  <div class="section">
    <button id="btnSchedule">料理!!!</button>

    <div>
      <button id="tabSchedule" class="view-tab active-tab">料理排程</button>
      <button id="tabIngredients" class="view-tab">所需食材</button>
    </div>

    <div id="viewContainer">
      <div id="scheduleResult"></div>
      <div id="ingredientResult" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    import { recipes } from './recipes.js';
    import { scheduleRecipes } from './scheduler.js';

    const filteredContainer = document.getElementById('filteredRecipes');
    const selectedContainer = document.getElementById('selectedRecipes');
    const scheduleResult = document.getElementById('scheduleResult');
    const ingredientResult = document.getElementById('ingredientResult');
    const toolButtons = document.querySelectorAll('.tool-btn');

    let selectedRecipeSet = new Set();
    let activeTools = new Set();

    function getSelectedTools() {
      return Array.from(activeTools);
    }

    toolButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tool = btn.dataset.tool;
        if (activeTools.has(tool)) {
          activeTools.delete(tool);
          btn.classList.remove('active');
        } else {
          activeTools.add(tool);
          btn.classList.add('active');
        }
        renderFilteredRecipes();
      });
    });

    function getUsedTools(recipe) {
      return recipe.steps.map(s => s.tool).filter(Boolean);
    }

    function renderFilteredRecipes() {
      const tools = getSelectedTools();
      filteredContainer.innerHTML = '';

      recipes.forEach(r => {
        const toolsNeeded = getUsedTools(r);
        const isNoToolNeeded = toolsNeeded.length === 0;
        const hasNoToolOption = tools.includes('無鍋具');

        const allToolsAvailable =
          (isNoToolNeeded && hasNoToolOption) ||
          (!isNoToolNeeded && toolsNeeded.every(t => tools.includes(t)));

        if (allToolsAvailable) {
          // 按鈕不能重複加入
          if (!selectedRecipeSet.has(r.id)) {
            const btn = document.createElement('button');
            btn.textContent = r.name;
            btn.onclick = () => {
              selectedRecipeSet.add(r.id);
              renderSelectedRecipes();
              renderFilteredRecipes(); // 按鈕重新渲染以避免重複
            };
            filteredContainer.appendChild(btn);
          }
        }
      });
    }

    function renderSelectedRecipes() {
      selectedContainer.innerHTML = '';
      recipes
        .filter(r => selectedRecipeSet.has(r.id))
        .forEach(r => {
          const label = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = r.id;
          cb.name = 'selected';
          label.appendChild(cb);
          label.appendChild(document.createTextNode(` ${r.name}`));
          selectedContainer.appendChild(label);
        });
    }

    function getColor(recipeId) {
      const colors = ['#5DADE2', '#58D68D', '#F5B041', '#AF7AC5', '#EC7063', '#52BE80', '#F4D03F', '#85929E'];
      return colors[recipeId % colors.length];
    }

    function renderSchedule(schedule) {
      const rows = {
        '無鍋具': [],
        '炒鍋': [],
        '電鍋': [],
        '湯鍋': [],
      };

      schedule.forEach(s => {
        const tool = s.tool || '無鍋具';
        rows[tool].push(s);
      });

      scheduleResult.innerHTML = '';

      Object.entries(rows).forEach(([tool, steps]) => {
        const row = document.createElement('div');
        row.className = 'timeline-row';

        const label = document.createElement('div');
        label.className = 'timeline-label';
        label.textContent = tool;
        row.appendChild(label);

        const container = document.createElement('div');
        container.className = 'step-container';

        const gap = 7;
        let lastEnd = 0;

        steps.sort((a, b) => a.start - b.start);

        steps.forEach(s => {
          const block = document.createElement('div');
          const duration = s.end - s.start;
          block.className = 'step-block';

          let leftPos = s.start * 15;
          if (leftPos < lastEnd + gap) {
            leftPos = lastEnd + gap;
          }
          block.style.left = `${leftPos}px`;

          let widthPx = duration * 15 - gap;
          if (widthPx < 5) widthPx = 5;

          block.style.width = `${widthPx}px`;
          block.style.backgroundColor = getColor(s.recipeId);

          const recipe = recipes.find(r => r.id === s.recipeId);
          const onlyOneStep = recipe && recipe.steps.length === 1;

          block.innerHTML = onlyOneStep
            ? `<div>${s.recipeName}</div><div>(${duration}分)</div>`
            : `<div>${s.recipeName}</div><div>${s.stepName} (${duration}分)</div>`;

          container.appendChild(block);
          lastEnd = leftPos + widthPx + gap;
        });

        row.appendChild(container);
        scheduleResult.appendChild(row);
      });
    }

    // 顯示所需食材
    function renderIngredients(recipeIds) {
      ingredientResult.innerHTML = '';

      recipeIds.forEach(id => {
        const recipe = recipes.find(r => r.id === id);
        if (!recipe) return;

        // 合併 ingredients 與 seasonings，去重複
        const allIngredients = [...(recipe.ingredients || []), ...(recipe.seasonings || [])];
        const uniqueList = [...new Set(allIngredients)];
        const line = document.createElement('div');
        line.textContent = `${recipe.name}：${uniqueList.join('、')}`;
        ingredientResult.appendChild(line);
      });
    }

    // 切換排程結果 / 所需食材 tab
    const tabSchedule = document.getElementById('tabSchedule');
    const tabIngredients = document.getElementById('tabIngredients');

    tabSchedule.addEventListener('click', () => {
      tabSchedule.classList.add('active-tab');
      tabIngredients.classList.remove('active-tab');
      scheduleResult.style.display = '';
      ingredientResult.style.display = 'none';
    });

    tabIngredients.addEventListener('click', () => {
      tabIngredients.classList.add('active-tab');
      tabSchedule.classList.remove('active-tab');
      scheduleResult.style.display = 'none';
      ingredientResult.style.display = '';
    });

    document.getElementById('btnSchedule').addEventListener('click', () => {
      const tools = getSelectedTools();
      const selectedIds = Array.from(document.querySelectorAll('input[name="selected"]:checked')).map(i => Number(i.value));

      if (selectedIds.length === 0) {
        alert('請先從已選料理中勾選要排程的料理');
        return;
      }

      const schedule = scheduleRecipes(selectedIds, tools);
      const latest = Math.max(...schedule.map(s => s.end));

      if (latest > 120) {
        alert('哪有人煮晚餐超過兩個小時!!!');
        return;
      }

      renderSchedule(schedule);
      renderIngredients(selectedIds); // 顯示所需食材
    });

    // 初始渲染
    renderFilteredRecipes();
    renderSelectedRecipes();
  </script>
</body>
</html>
